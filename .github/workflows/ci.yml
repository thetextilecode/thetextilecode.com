name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  pull-requests: write

jobs:
  lint-and-build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check formatting (Prettier)
        run: npx prettier --check "**/*.{mdx,tsx,ts,md,js,jsx,json}"

      - name: Lint (ESLint)
        run: npm run lint

      - name: Build
        run: npm run build

  e2e-tests:
    needs: lint-and-build
    timeout-minutes: 60
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps chromium

      - name: Create screenshots directory
        run: mkdir -p screenshots

      - name: Run Playwright tests
        run: npm run test:e2e

      - name: Upload screenshots
        uses: actions/upload-artifact@v6
        if: ${{ !cancelled() }}
        with:
          name: screenshots-${{ github.event.pull_request.number || github.sha }}
          path: screenshots/
          retention-days: 30

      - name: Comment on PR with screenshot links
        if: github.event_name == 'pull_request' && !cancelled()
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // Check if screenshots directory exists and has files
            const screenshotsDir = 'screenshots';
            let screenshotFiles = [];
            
            if (fs.existsSync(screenshotsDir)) {
              screenshotFiles = fs.readdirSync(screenshotsDir)
                .filter(f => f.endsWith('.png'))
                .sort();
            }
            
            if (screenshotFiles.length === 0) {
              console.log('No screenshots found, skipping comment');
              return;
            }
            
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const artifactName = `screenshots-${context.issue.number}`;
            
            // Group screenshots by page
            const desktopScreenshots = screenshotFiles.filter(f => !f.includes('-mobile'));
            const mobileScreenshots = screenshotFiles.filter(f => f.includes('-mobile'));
            
            let body = `## ðŸ“¸ Visual Preview Screenshots\n\n`;
            body += `Screenshots captured from this PR's build. [View full run](${runUrl})\n\n`;
            body += `### Download\n`;
            body += `Download the **${artifactName}** artifact from the [Actions run](${runUrl}) to view all screenshots.\n\n`;
            body += `### Pages Captured\n\n`;
            body += `| Page | Desktop | Mobile |\n`;
            body += `|------|---------|--------|\n`;
            
            for (const file of desktopScreenshots) {
              const pageName = file.replace('.png', '');
              const mobileFile = `${pageName}-mobile.png`;
              const hasMobile = mobileScreenshots.includes(mobileFile);
              body += `| ${pageName} | âœ… | ${hasMobile ? 'âœ…' : 'â€”'} |\n`;
            }
            
            body += `\n---\n`;
            body += `<sub>ðŸ¤– This comment is automatically generated by the CI pipeline.</sub>`;
            
            // Find existing comment to update
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('ðŸ“¸ Visual Preview Screenshots')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }
